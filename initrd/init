#!/bin/sh

export PATH=".:/:/usr/sbin:/usr/bin:/sbin:/bin"
export LD_LIBRARY_PATH="/lib:/lib/i386-linux-gnu:/lib64:/lib64/x86_64-linux-gnu:/usr/lib/i386-linux-gnu:/usr/lib64/x86_64-linux-gnu"
MEMORY=/memory
CHANGES=$MEMORY/changes
UNION=$MEMORY/union
DATAMNT=$MEMORY/data
SYSTEM=$MEMORY/system
WORK=$MEMORY/work
RAM=$MEMORY/ram

. /lib/.config

if [ ! -e /lib/initramfs_escaped ]; then
	SWITCH=/m
	mkdir -p ${SWITCH}
	mount -t tmpfs -o size="100%" tmpfs ${SWITCH}
	cp -a /??* ${SWITCH} 2>/dev/null
	cd ${SWITCH}
	touch lib/initramfs_escaped
	exec switch_root . $0
fi

persistent_changes()
{	
	if grep -vq perch /proc/cmdline; then
		return
	fi
	mkdir -p ${DATAMNT}/changes
	CHANGES1="${DATAMNT}/changes"
	T1="$CHANGES1/.empty"
	T2="$T1"2
	touch "$T1" ${null} && rm -f "$T1" ${null}
	if [ $? -ne 0 ]; then
		return
	fi
	touch "$T1" && ln -sf "$T1" "$T2" ${null} && \
	chmod +x "$T1" ${null} && test -x "$T1" && \
	chmod -x "$T1" ${null} && test ! -x "$T1" && \
	rm "$T1" "$T2" ${null}
	if [ $? -eq 0 ]; then
		mount --bind "$CHANGES1" "$2"
		return
	fi
	if [ -e "$CHANGES1/changes.dat" ]; then
		EXISTS="true"
	fi
	mount.dynfilefs "$CHANGES1/changes.dat" 4000 "$2"
	if [ ! "$EXISTS" ]; then
		mke2fs -F "$2/loop.fs" ${null}
	fi
	mount -o loop,sync "$2/loop.fs" "$2"
	rm -f "$T1" "$T2" ${null}
	rmdir "$2/lost+found" ${null}
}
debug_shell()
{
	if [ "$DEBUG_IS_ENABLED" ]; then
		echo -e "Debug shell activated!\nControl+D or 'exit' to contiunue boot.\n"
		setsid sh -c 'exec sh </dev/tty1 >/dev/tty1 2>&1'
	fi
}
change_root()
{
	cd "$1"
	umount -f /sys /proc
	echo "proc /proc proc defaults 0 0" >etc/fstab
	echo "sysfs /sys sysfs defaults 0 0" >>etc/fstab
	echo "devpts /dev/pts devpts gid=5,mode=620 0 0" >>etc/fstab
	echo "tmpfs /dev/shm tmpfs defaults 0 0" >>etc/fstab
	echo "overlay / overlay defaults 0 0" >>etc/fstab
	mkdir -p run
	mount -t tmpfs tmpfs run
	mkdir -p run/initramfs
	mount -o remount,ro overlay .
	pivot_root . run/initramfs
	exec chroot . init
}

mkdir -p ${CHANGES} ${UNION} ${DATAMNT} ${SYSTEM} ${WORK} ${RAM}
mount -t proc proc /proc
echo "0" >/proc/sys/kernel/printk
mount -t sysfs sysfs /sys
if grep -q debug /proc/cmdline; then
	DEBUG_IS_ENABLED=1
	set -x
else
	null=">/dev/null 2>&1"
fi
debug_shell
ln -sf /proc/mounts /etc/mtab
find /lib/modules/`uname -r` -name "*.ko" | sed -r "s:^.*/|[.]ko\$::g" | xargs -n 1 modprobe ${null}
sleep 3
mdev -s ${null}
if [ -e /sys/block/zram0/disksize ]; then
	echo 536870912 >/sys/block/zram0/disksize
	mkswap /dev/zram0 ${null}
	swapon /dev/zram0 ${null}
	echo 100 >/proc/sys/vm/swappiness
fi
mdadm --assemble --scan ${null}
debug_shell
for i in `blkid | cut -d: -f1 | sort | grep -vE "loop|zram|ram"`; do
	echo "Searching ${DISTRO} on ${i} ..."
	mount ${i} ${DATAMNT} ${null}
	sleep 1
	if [ -e ${DATAMNT}/${DISTRO}/system.sfs ]; then
		echo "Found ${DISTRO} on ${i}"
		if grep -q toram /proc/cmdline; then
			cp -raf ${DATAMNT}/* ${RAM} ${null}
			umount -f ${DATAMNT} ${null}
			mv -f ${RAM}/* ${DATAMNT} ${null}
		fi
		mount ${DATAMNT}/${DISTRO}/system.sfs ${SYSTEM} ${null}
		sleep 1.5
		break
	else
		umount -f ${DATAMNT} ${null} ${null}
	fi
done
debug_shell
persistent_changes ${SYSTEM} ${CHANGES} ${null}
debug_shell
mount -t overlay -o workdir=${WORK},upperdir=${CHANGES},lowerdir=${SYSTEM} overlay ${UNION} ${null}
debug_shell
echo "Starting ${DISTRO}"
sleep 2
change_root "$UNION" || clear; echo "!!ERROR occured, you shouldn't be here.!!"; sleep 3
while :; do
	clear
	echo "Rescue shell activated!"
	setsid sh -c 'exec sh </dev/tty1 >/dev/tty1 2>&1'
done
